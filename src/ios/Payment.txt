//
//  AppDelegate+URL.m
//  NicePayAppSample
//
//  Created by  on 12. 5. 14..
//  Copyright (c) 2012 __MyCompanyName__. All rights reserved.
//

#import "AppDelegate.h"


@implementation AppDelegate (Payment)
-(void) callByPaymentAppWith:(NSURL*)url
{
    NSString* URLkeyString = [NSString stringWithString:[url absoluteString]];
    NSLog(@"URLkey : %@",URLkeyString);
    
#define MY_APP_URL_KEY  @"gajago://"
    if(URLkeyString !=  nil) {
        if([URLkeyString hasPrefix:MY_APP_URL_KEY]) {
            NSRange range = [URLkeyString rangeOfString:@"?bankpaycode"];    //계좌이체 인경우
            if(range.location != NSNotFound) { //계좌이체 인증 후 거래 진행
                
                //[MY_APP_URL_KEY length]+1 => 계좌이체인 경우  scheme + ? 로 리던 되어 "?" 도 함께 삭제 함.
                //nicepaysample://?bankpaycode=xxxx ...." 에서 "bankpaycode=xxxx ...." 추출하기 위함
                URLkeyString = [URLkeyString substringFromIndex:[MY_APP_URL_KEY length]+1];
//                [self.webViewController requestBankPayResult:URLkeyString];
                return;
            }
            
            //결제 요청 필드 내
            range = [URLkeyString rangeOfString:@"ISPCancel"];
            if(range.location != NSNotFound) { //ISP 취소인 경우
                UIAlertView* alertView = [[UIAlertView alloc]initWithTitle:@"알림"
                                                                    message:@"결제를 취소하셨습니다."
                                                                   delegate:self cancelButtonTitle:@"확인"
                                                          otherButtonTitles:nil];
                alertView.tag = 900;
                [alertView show];
                return;
            }
            
            range = [URLkeyString rangeOfString:@"ispResult.jsp"];
            if(range.location != NSNotFound) { //ISP 인증 후 결제 진행
                URLkeyString = [URLkeyString substringFromIndex:[MY_APP_URL_KEY length]+3];
//                [self.webViewController requesIspPayResult:URLkeyString];
                return;
            }
        }
    }
    
}

- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex
{
    if(alertView.tag == 900){
        //[self.webViewController close];  // ISP 결제 취소로 인해 결제 화면을 닫습니다.
    }
}
@end
